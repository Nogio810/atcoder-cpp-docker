FROM ubuntu:22.04

# ç’°å¢ƒã‚’éžå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã«
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo

# åŸºæœ¬ãƒ„ãƒ¼ãƒ«ãƒ»é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    build-essential \
    g++ \
    gdb \
    cmake \
    git \
    zip \
    unzip \
    curl \
    wget \
    vim \
    python3 \
    python3-pip \
    nodejs \
    npm \
    # AtCoderç’°å¢ƒã«åˆã‚ã›ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    libgmp-dev \
    libmpfr-dev \
    libmpc-dev \
    libboost-all-dev \
    # æ—¥æœ¬èªžç’°å¢ƒ
    language-pack-ja-base \
    language-pack-ja \
    fonts-ipafont \
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ„ãƒ¼ãƒ«
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# æ—¥æœ¬èªžãƒ­ã‚±ãƒ¼ãƒ«ã®è¨­å®š
RUN locale-gen ja_JP.UTF-8
ENV LANG=ja_JP.UTF-8
ENV LANGUAGE=ja_JP:ja
ENV LC_ALL=ja_JP.UTF-8

# AtCoderé–¢é€£ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip3 install --no-cache-dir \
    online-judge-tools \
    aclogin \
    requests \
    beautifulsoup4

# atcoder-cli (acc)
RUN npm install -g atcoder-cli

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /app

# é–‹ç™ºç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆsudoæ¨©é™ä»˜ä¸Žï¼‰
RUN apt-get update && apt-get install -y sudo && \
    useradd -m devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/devuser && \
    chmod 0440 /etc/sudoers.d/devuser && \
    chown -R devuser:devuser /app && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY templates/ /app/templates/

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
USER devuser

# accã®è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™
RUN mkdir -p /home/devuser/.config/atcoder-cli-nodejs

# ã‚ˆãä½¿ã†C++ã®å®Ÿè¡Œç’°å¢ƒã‚’æº–å‚™ï¼ˆ.bashrcã«è¿½åŠ ï¼‰
RUN echo 'alias g++="g++ -std=c++17 -Wall -Wextra -O2"' >> ~/.bashrc && \
    echo 'alias gpp="g++ -std=c++17 -Wall -Wextra -O2"' >> ~/.bashrc && \
    echo 'alias run="g++ -std=c++17 -Wall -Wextra -O2 -o main main.cpp && ./main"' >> ~/.bashrc

# AtCoderç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
RUN mkdir -p /home/devuser/bin && \
    cat > /home/devuser/bin/setup-atcoder.sh << 'EOF'\
    #!/bin/bash
    echo "ðŸš€ AtCoderç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰"\
    echo ""\
    echo "ðŸ“‹ ãƒ­ã‚°ã‚¤ãƒ³æ‰‹é †ï¼š"\
    echo "1. ãƒ–ãƒ©ã‚¦ã‚¶ã§AtCoderã«ãƒ­ã‚°ã‚¤ãƒ³"\
    echo "2. F12ã‚­ãƒ¼ â†’ Application/Storage â†’ Cookies â†’ atcoder.jp"\
    echo "3. REVEL_SESSIONã®å€¤ã‚’ã‚³ãƒ”ãƒ¼"\
    echo "4. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'aclogin' ã‚’å®Ÿè¡Œã—ã¦ã‚¯ãƒƒã‚­ãƒ¼å€¤ã‚’è²¼ã‚Šä»˜ã‘"\
    echo ""\
    echo "ðŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒžãƒ³ãƒ‰ï¼š"\
    echo "  aclogin                    # AtCoderã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š"\
    echo "  acc new [contest]          # ã‚³ãƒ³ãƒ†ã‚¹ãƒˆç’°å¢ƒä½œæˆ"\
    echo "  acc add [problem]          # å•é¡Œè¿½åŠ "\
    echo "  oj test                    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"\
    echo "  acc submit                 # è§£ç­”æå‡º"\
    echo "  run                        # main.cppã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ»å®Ÿè¡Œ"\
    echo ""\
    echo "ðŸ“š ä¾¿åˆ©ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼š"\
    echo "  g++   = g++ -std=c++17 -Wall -Wextra -O2"\
    echo "  gpp   = g++ -std=c++17 -Wall -Wextra -O2"\
    echo "  run   = ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«â†’å®Ÿè¡Œ"\
    echo ""\
    echo "ðŸŽ¯ ã¾ãšã¯ 'aclogin' ã§ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼"\
    EOF

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
RUN chmod +x /home/devuser/bin/setup-atcoder.sh

# PATHã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®binãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
RUN echo 'export PATH=$PATH:/home/devuser/bin' >> ~/.bashrc

WORKDIR /app
CMD ["/bin/bash"]